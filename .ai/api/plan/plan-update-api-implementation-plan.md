# API Endpoint Implementation Plan: PUT /notes/{note_id}/plan

## 1. Overview
This endpoint allows users to update an existing active plan associated with a specific note. If the plan being updated was originally generated by AI (type is 'AI'), its type will be changed to 'HYBRID' to reflect the manual modifications.

## 2. Request Details
- **HTTP Method**: PUT
- **URL Structure**: `/notes/{note_id}/plan`
- **Path Parameters**:
    - `note_id` (integer, required): The ID of the note whose plan is being updated
- **Request Body**:
    ```json
    {
            "plan_text": "Updated plan text..."
    }
    ```

## 3. Types and Models
### Data Transfer Objects (DTOs)
Create new DTOs for update operation:

```python
class UpdatePlanInDTO(BaseModel):
        note_id: int
        user_id: UUID
        plan_text: str
```

UpdatePlanOutDTO (can reuse existing GetActivePlanOutDTO since it has the same structure)

### Schemas
Already exists: PlanUpdateInSchema with plan_text field

## 4. Response Details
### Success Response (200 OK):
```json
{
    "plan_id": 456,
    "note_id": 123,
    "plan_text": "Updated plan text...",
    "plan_type": "HYBRID",
    "plan_status": "ACTIVE",
    "generation_id": "550e8400-e29b-41d4-a716-446655440000",
    "created_at": "2025-05-11T11:00:00Z",
    "updated_at": "2025-05-11T11:05:00Z"
}
```

### Error Responses:
- **400 Bad Request**: Invalid input data
- **401 Unauthorized**: User not authenticated
- **404 Not Found**: Note or active plan not found, or user doesn't own the note
- **422 Unprocessable Entity**: Validation error (e.g., plan_text too long)

## 5. Data Flow
1. API endpoint receives a PUT request with note ID and plan update data
2. Authenticate user through JWT token (handled by FastAPI Users middleware)
3. Validate input data through Pydantic model (PlanUpdateInSchema)
4. Call UpdatePlanUseCase.execute() with validated data
5. The use case will:
     - Verify the note exists and belongs to the user
     - Retrieve the current active plan for the note
     - Update the plan text
     - If the original plan type was 'AI', update it to 'HYBRID'
     - Persist changes to the database
6. Return updated plan data in response

## 6. Security Considerations
- **Authentication**: Endpoint requires valid JWT token in the Cookie header
- **Authorization**: Check if the note with the given ID belongs to the authenticated user
- **Input Validation**:
    - Validate plan_text length against configured maximum (5000 characters)
    - Ensure proper encoding and sanitation of user input

## 7. Error Handling
- **NoteNotFoundError**: When note doesn't exist or doesn't belong to the authenticated user (404)
- **ActivePlanNotFoundError**: When no active plan exists for the specified note (404)
- **ValidationError**: When input data fails validation (422)
- **DatabaseError**: When database operation fails (500)

## 8. Performance Considerations
- Database updates should be executed within a transaction to ensure consistency
- Adding an index on (note_id, status) may improve query performance
- Monitor query execution time for potential optimization

## 9. Implementation Steps
1. **Create Data Transfer Objects**
     - Create UpdatePlanInDTO class in plan_dtos.py

2. **Create Update Plan Use Case**
     - Create UpdatePlanUseCase class in a new file src/apps/plans/usecases/update_plan_usecase.py
     - Implement execute method with functionality to update a plan and handle type changes
     - Inject required dependencies (repository, etc.)

3. **Add Dependency Provider Function**
     - Add get_update_plan_usecase function in src/apps/plans/dependencies.py

4. **Update Model Logic**
     - Add update_text method to Plan model in plan.py to handle business logic
     - Method should update plan_text and change type from 'AI' to 'HYBRID' when appropriate

5. **Implement API Endpoint**
     - Add @plan_router.put() endpoint method in api.py
     - Map parameters and error scenarios to appropriate HTTP responses

6. **Write Unit Tests**
     - Test model's update_text method behavior
     - Test use case with different scenarios (successful update, note not found, plan not found)
     - Test API endpoint for correct HTTP responses

7. **Update API Documentation**
     - Ensure OpenAPI documentation accurately describes the endpoint behavior

8. **Validate Implementation**
     - Test the endpoint manually using Swagger UI or Postman
     - Verify all error conditions are handled properly
