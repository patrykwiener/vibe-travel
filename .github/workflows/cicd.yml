name: CI/CD Pipeline

# CI/CD Strategy:
# - develop branch ‚Üí automatic deploy to staging
# - master branch ‚Üí manual approval ‚Üí deploy to production
# - pull requests ‚Üí only CI checks (no deployment)

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]

env:
  # Container Registry
  REGISTRY: ghcr.io
  BACKEND_IMAGE_NAME: ${{ github.repository }}/backend
  FRONTEND_IMAGE_NAME: ${{ github.repository }}/frontend

  # Database configuration for CI
  POSTGRES_SERVER: localhost
  POSTGRES_PORT: 5432
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres
  POSTGRES_DB: vibetravel_test

  # FastAPI Settings for CI
  PROJECT_NAME: VibeTravels
  SECRET_KEY: test-secret-key-for-ci
  ENVIRONMENT: dev
  API_V1_STR: /api/v1
  BACKEND_CORS_ORIGINS: '["http://localhost:3000", "http://localhost:8080"]'

  # First Admin User for tests
  FIRST_SUPERUSER: admin@test.com
  FIRST_SUPERUSER_PASSWORD: testpassword

  # AI generation settings (mock for CI)
  USE_MOCK_AI: 1
  OPENROUTER_API_KEY: mock-key
  OPENROUTER_MODEL: mock-model

jobs:
  backend:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: vibetravel_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build backend image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        load: true
        tags: backend:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Create .env file
      run: |
        cat > .env << EOF
        PROJECT_NAME=${PROJECT_NAME}
        SECRET_KEY=${SECRET_KEY}
        ENVIRONMENT=${ENVIRONMENT}
        API_V1_STR=${API_V1_STR}
        BACKEND_CORS_ORIGINS=${BACKEND_CORS_ORIGINS}
        POSTGRES_SERVER=${POSTGRES_SERVER}
        POSTGRES_PORT=${POSTGRES_PORT}
        POSTGRES_USER=${POSTGRES_USER}
        POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
        POSTGRES_DB=${POSTGRES_DB}
        FIRST_SUPERUSER=${FIRST_SUPERUSER}
        FIRST_SUPERUSER_PASSWORD=${FIRST_SUPERUSER_PASSWORD}
        USE_MOCK_AI=${USE_MOCK_AI}
        OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
        OPENROUTER_MODEL=${OPENROUTER_MODEL}
        EOF

    - name: Wait for PostgreSQL to be ready
      run: |
        until pg_isready -h localhost -p 5432 -U postgres; do
          echo "Waiting for postgres..."
          sleep 2
        done

    - name: Run backend linting
      run: |
        docker run --rm \
          -v ${{ github.workspace }}/backend:/app \
          -w /app \
          backend:latest \
          ./scripts/lint.sh

    - name: Run backend security scan
      run: |
        # Create a script for better error handling
        docker run --rm \
          -v ${{ github.workspace }}/backend:/app \
          -w /app \
          backend:latest \
          sh -c "
            set -e
            echo 'üîç Installing security scanning tools...'
            pip install --upgrade pip
            pip install safety==3.2.8 bandit==1.7.5

            echo 'üõ°Ô∏è Running safety check...'
            safety check --json > /app/safety-report.json
            echo 'Safety check passed ‚úÖ'

            echo 'üîí Running bandit security scan...'
            bandit -r src/ -f json -o /app/bandit-report.json -ll
            echo 'Bandit scan passed ‚úÖ'

            echo '‚úÖ All security scans completed successfully!'
          "

    - name: Check security scan results
      run: |
        echo "üìä Security scan summary:"
        if [ -f backend/safety-report.json ]; then
          echo "‚úÖ Safety report generated"
          # Check if there are any vulnerabilities
          if grep -q '"vulnerabilities"' backend/safety-report.json; then
            echo "‚ö†Ô∏è  Vulnerabilities found in safety scan"
            cat backend/safety-report.json | grep -A 5 -B 5 "vulnerabilities" || echo "No vulnerability details found"
          fi
        else
          echo "‚ùå Safety report not found"
          exit 1
        fi

        if [ -f backend/bandit-report.json ]; then
          echo "‚úÖ Bandit report generated"
          # Check bandit results
          ISSUES=$(cat backend/bandit-report.json | grep -o '"SEVERITY"' | wc -l || echo "0")
          echo "üîç Bandit found $ISSUES potential security issues"
        else
          echo "‚ùå Bandit report not found"
          exit 1
        fi

    - name: Upload security scan results
      uses: actions/upload-artifact@v4
      with:
        name: backend-security-reports
        path: |
          backend/safety-report.json
          backend/bandit-report.json
      if: always()

    - name: Run database pre-start checks
      run: |
        docker run --rm \
          --env-file .env \
          --network host \
          -v ${{ github.workspace }}/backend:/app \
          -w /app \
          backend:latest \
          python tests_pre_start.py

    - name: Run backend tests with coverage
      run: |
        # Run tests with coverage (using setup.cfg configuration)
        docker run --name backend-test \
          --env-file .env \
          --network host \
          -v ${{ github.workspace }}/backend:/app \
          -w /app \
          backend:latest \
          pytest -vv

        # Copy coverage reports from container to host
        mkdir -p ${{ github.workspace }}/backend-coverage
        docker cp backend-test:/app/htmlcov/. ${{ github.workspace }}/backend-coverage/ || echo "No HTML coverage found"
        docker cp backend-test:/app/coverage.xml ${{ github.workspace }}/backend-coverage/ || echo "No XML coverage found"
        docker rm backend-test

    - name: Upload backend coverage reports
      uses: actions/upload-artifact@v4
      with:
        name: backend-coverage
        path: backend-coverage/

  frontend:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build frontend image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        load: true
        tags: frontend:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          VITE_BACKEND_URL=http://localhost:8000

    - name: Run frontend linting
      run: |
        docker run --rm \
          -v ${{ github.workspace }}/frontend:/app \
          -v /app/node_modules \
          -w /app \
          frontend:latest \
          sh -c "npm run lint"

    - name: Run frontend type checking
      run: |
        docker run --rm \
          -v ${{ github.workspace }}/frontend:/app \
          -v /app/node_modules \
          -w /app \
          frontend:latest \
          sh -c "npm run type-check"

    - name: Run frontend security audit
      run: |
        docker run --rm \
          -v ${{ github.workspace }}/frontend:/app \
          -v /app/node_modules \
          -w /app \
          frontend:latest \
          sh -c "
            echo 'üîç Running npm security audit...' &&
            npm audit --audit-level high --json > /app/audit-report.json &&
            echo '‚úÖ Frontend security audit completed successfully!'
          "

    - name: Check frontend security results
      run: |
        echo "üìä Frontend security audit summary:"
        if [ -f frontend/audit-report.json ]; then
          echo "‚úÖ Audit report generated"
          # Check for vulnerabilities
          VULNERABILITIES=$(cat frontend/audit-report.json | grep -o '"vulnerabilities":[0-9]*' | grep -o '[0-9]*' || echo "0")
          echo "üîç Found $VULNERABILITIES vulnerabilities"
          if [ "$VULNERABILITIES" -gt 0 ]; then
            echo "‚ö†Ô∏è  High-severity vulnerabilities detected"
            echo "üìã Run 'npm audit' locally to see details"
            exit 1
          fi
        else
          echo "‚ùå Audit report not found"
          exit 1
        fi

    - name: Upload frontend security audit
      uses: actions/upload-artifact@v4
      with:
        name: frontend-security-reports
        path: frontend/audit-report.json
      if: always()

    - name: Run frontend tests with coverage
      run: |
        # Run tests without mounting coverage directory
        docker run --name frontend-test \
          -v ${{ github.workspace }}/frontend:/app \
          -v /app/node_modules \
          -w /app \
          frontend:latest \
          sh -c "npm run test:coverage"

        # Copy coverage from container to host
        mkdir -p ${{ github.workspace }}/frontend-coverage
        docker cp frontend-test:/app/coverage/. ${{ github.workspace }}/frontend-coverage/
        docker rm frontend-test

    - name: Upload frontend coverage reports
      uses: actions/upload-artifact@v4
      with:
        name: frontend-coverage
        path: frontend-coverage/

  push-backend-image:
    needs: backend
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop')

    permissions:
      contents: read
      packages: write

    outputs:
      backend-image: ${{ steps.backend-meta.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract backend metadata
        id: backend-meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ steps.backend-meta.outputs.tags }}
          labels: ${{ steps.backend-meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  push-frontend-image:
    needs: frontend
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop')

    permissions:
      contents: read
      packages: write

    outputs:
      frontend-image: ${{ steps.frontend-meta.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract frontend metadata
        id: frontend-meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ steps.frontend-meta.outputs.tags }}
          labels: ${{ steps.frontend-meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-staging:
    needs: [push-backend-image, push-frontend-image]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    environment: staging

    steps:
      - name: Mock Deploy to Staging
        run: |
          echo "üöÄ Deploying to staging environment..."
          echo "Backend image: ${{ needs.push-backend-image.outputs.backend-image }}"
          echo "Frontend image: ${{ needs.push-frontend-image.outputs.frontend-image }}"
          echo "Environment: Staging"
          echo "‚úÖ Staging deployment completed successfully!"

      - name: Health Check
        run: |
          echo "üîç Running health checks on staging..."
          echo "‚úÖ All health checks passed!"

  deploy-production:
    needs: [push-backend-image, push-frontend-image]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    environment:
      name: production
      url: https://vibe-travels-production.com

    steps:
      - name: Manual Approval Required
        run: |
          echo "‚è≥ Waiting for manual approval..."
          echo "This deployment requires approval in GitHub Actions tab"
          echo "Navigate to Actions ‚Üí This workflow ‚Üí Review deployments"

      - name: Mock Deploy to Production
        run: |
          echo "üöÄ Deploying to production environment..."
          echo "Backend image: ${{ needs.push-backend-image.outputs.backend-image }}"
          echo "Frontend image: ${{ needs.push-frontend-image.outputs.frontend-image }}"
          echo "Environment: Production"
          echo "‚úÖ Production deployment completed successfully!"

      - name: Health Check
        run: |
          echo "üîç Running health checks on production..."
          echo "‚úÖ All health checks passed!"

      - name: Notify Success
        run: |
          echo "üéâ VibeTravels has been successfully deployed to production!"
          echo "üåê Application is now live at: https://vibe-travels-production.com"
